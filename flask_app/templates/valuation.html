{% extends "base.html" %}

{% block title %}ä¸å‹•ç”£è©•ä¾¡ãƒ„ãƒ¼ãƒ« - ä¸å‹•ç”£è©•ä¾¡é¡æ¨å®šã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
    .tab-content {
        margin-top: 1.5rem;
    }

    .upload-area {
        border: 3px dashed #007bff;
        border-radius: 10px;
        padding: 3rem 2rem;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: #0056b3;
        background-color: #e7f1ff;
    }

    .upload-area.dragover {
        border-color: #28a745;
        background-color: #d4edda;
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 4rem;
        color: #007bff;
        margin-bottom: 1rem;
    }

    .result-card {
        display: none;
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .valuation-amount {
        font-size: 2.5rem;
        font-weight: bold;
        color: #28a745;
    }

    .valuation-label {
        font-size: 1.1rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .detail-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid #dee2e6;
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #495057;
    }

    .detail-value {
        color: #212529;
    }

    #loadingSpinner {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-2">ä¸å‹•ç”£è©•ä¾¡ãƒ„ãƒ¼ãƒ«</h2>
            <p class="text-muted">å›ºå®šè³‡ç”£ç™»éŒ²äº‹é …è¨¼æ˜æ›¸ã‹ã‚‰è‡ªå‹•ã§è©•ä¾¡é¡ã‚’è¨ˆç®—ã€ã¾ãŸã¯æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <ul class="nav nav-tabs nav-fill mb-4" id="inputMethodTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-upload"
                    type="button" role="tab" aria-controls="file-upload" aria-selected="true">
                <i class="bi bi-cloud-upload"></i> ãƒ•ã‚¡ã‚¤ãƒ«ã§è‡ªå‹•å…¥åŠ›
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-input"
                    type="button" role="tab" aria-controls="manual-input" aria-selected="false">
                <i class="bi bi-pencil-square"></i> æ‰‹å‹•ã§å…¥åŠ›
            </button>
        </li>
    </ul>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content" id="inputMethodTabContent">
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ãƒ– -->
        <div class="tab-pane fade show active" id="file-upload" role="tabpanel" aria-labelledby="file-tab">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title mb-4">å›ºå®šè³‡ç”£ç™»éŒ²äº‹é …è¨¼æ˜æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>

                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">ğŸ“„</div>
                            <h5>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</h5>
                            <p class="text-muted mb-3">ã¾ãŸã¯</p>
                            <label for="fileInput" class="btn btn-primary btn-lg">
                                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                            </label>
                            <input type="file" id="fileInput" name="file" accept="image/*,.pdf" style="display: none;">
                            <p class="text-muted mt-3 mb-0">
                                <small>å¯¾å¿œå½¢å¼: JPG, PNG, PDFï¼ˆæœ€å¤§10MBï¼‰</small>
                            </p>
                        </div>

                        <div id="fileInfo" class="mt-3" style="display: none;">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="bi bi-file-earmark-text fs-4 me-3"></i>
                                <div>
                                    <strong>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:</strong>
                                    <span id="fileName"></span>
                                    (<span id="fileSize"></span>)
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled>
                                <i class="bi bi-calculator"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦è©•ä¾¡é¡ã‚’è¨ˆç®—
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- æ‰‹å‹•å…¥åŠ›ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="manual-input" role="tabpanel" aria-labelledby="manual-tab">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title mb-4">ç‰©ä»¶æƒ…å ±ã‚’å…¥åŠ›</h5>

                    <form id="manualForm">
                        <div class="mb-3">
                            <label for="address" class="form-label">æ‰€åœ¨åœ° <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-lg" id="address" name="address"
                                   placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·1-1-1" required>
                            <div class="form-text">ç‰©ä»¶ã®æ‰€åœ¨åœ°ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="land_area" class="form-label">åœŸåœ°é¢ç©ï¼ˆã¡ï¼‰<span class="text-danger">*</span></label>
                                <input type="number" class="form-control form-control-lg" id="land_area" name="land_area"
                                       step="0.01" min="0" placeholder="ä¾‹: 150.50" required>
                                <div class="form-text">åœŸåœ°ã®é¢ç©ã‚’å¹³æ–¹ãƒ¡ãƒ¼ãƒˆãƒ«ã§å…¥åŠ›ã€‚</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="total_floor_area" class="form-label">å»¶åºŠé¢ç©ï¼ˆã¡ï¼‰<span class="text-danger">*</span></label>
                                <input type="number" class="form-control form-control-lg" id="total_floor_area" name="total_floor_area"
                                       step="0.01" min="0" placeholder="ä¾‹: 200.00" required>
                                <div class="form-text">å»ºç‰©ã®å»¶ã¹åºŠé¢ç©ã‚’å…¥åŠ›ã€‚</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="building_structure" class="form-label">å»ºç‰©ã®æ§‹é€  <span class="text-danger">*</span></label>
                                <select class="form-select form-select-lg" id="building_structure" name="building_structure" required>
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="æœ¨é€ ">æœ¨é€ </option>
                                    <option value="é‰„éª¨é€ ">é‰„éª¨é€ </option>
                                    <option value="é‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ">é‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ </option>
                                </select>
                                <div class="form-text">å»ºç‰©ã®ä¸»è¦æ§‹é€ ã‚’é¸æŠã€‚</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="build_year" class="form-label">å»ºç¯‰å¹´ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control form-control-lg" id="build_year" name="build_year"
                                       min="1900" max="2025" placeholder="ä¾‹: 2015" required>
                                <div class="form-text">å»ºç‰©ãŒå»ºç¯‰ã•ã‚ŒãŸå¹´ã‚’å…¥åŠ›ã€‚</div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="alert alert-info" role="alert">
                            <strong><i class="bi bi-info-circle"></i> æ³¨æ„äº‹é …</strong>
                            <ul class="mb-0 mt-2">
                                <li>è©•ä¾¡é¡ã¯ç°¡æ˜“çš„ãªè¨ˆç®—ã«åŸºã¥ãæ¨å®šå€¤ã§ã™</li>
                                <li>å®Ÿéš›ã®å›ºå®šè³‡ç”£ç¨è©•ä¾¡é¡ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</li>
                                <li>å‚è€ƒå€¤ã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„</li>
                            </ul>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-calculator"></i> è©•ä¾¡é¡ã‚’è¨ˆç®—
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ -->
    <div id="loadingSpinner" class="text-center my-5">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">è¨ˆç®—ä¸­...</span>
        </div>
        <p class="mt-3 text-muted">è©•ä¾¡é¡ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™...</p>
    </div>

    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="resultArea" class="result-card mt-5">
        <h3 class="mb-4 text-center">è©•ä¾¡çµæœ</h3>

        <div class="row g-4 mb-4">
            <!-- åˆè¨ˆè©•ä¾¡é¡ -->
            <div class="col-lg-12">
                <div class="card border-success shadow-lg">
                    <div class="card-body text-center p-4">
                        <div class="valuation-label">åˆè¨ˆè©•ä¾¡é¡</div>
                        <div class="valuation-amount text-success" id="totalValuation">Â¥0</div>
                    </div>
                </div>
            </div>

            <!-- åœŸåœ°ã®è©•ä¾¡é¡ -->
            <div class="col-md-6">
                <div class="card border-primary shadow">
                    <div class="card-body text-center p-4">
                        <div class="valuation-label">åœŸåœ°ã®è©•ä¾¡é¡</div>
                        <div class="valuation-amount text-primary" style="font-size: 2rem;" id="landValuation">Â¥0</div>
                    </div>
                </div>
            </div>

            <!-- å»ºç‰©ã®è©•ä¾¡é¡ -->
            <div class="col-md-6">
                <div class="card border-info shadow">
                    <div class="card-body text-center p-4">
                        <div class="valuation-label">å»ºç‰©ã®è©•ä¾¡é¡</div>
                        <div class="valuation-amount text-info" style="font-size: 2rem;" id="buildingValuation">Â¥0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è©³ç´°æƒ…å ± -->
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-file-text"></i> è©•ä¾¡ã®æ ¹æ‹ æƒ…å ±</h5>
            </div>
            <div class="card-body">
                <div class="detail-item">
                    <div class="row">
                        <div class="col-sm-4 detail-label">æ‰€åœ¨åœ°</div>
                        <div class="col-sm-8 detail-value" id="detailAddress">-</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="row">
                        <div class="col-sm-4 detail-label">åœŸåœ°é¢ç©</div>
                        <div class="col-sm-8 detail-value" id="detailLandArea">-</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="row">
                        <div class="col-sm-4 detail-label">è·¯ç·šä¾¡ï¼ˆæ¨å®šï¼‰</div>
                        <div class="col-sm-8 detail-value" id="detailRoadPrice">-</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="row">
                        <div class="col-sm-4 detail-label">å»ºç‰©æ§‹é€ </div>
                        <div class="col-sm-8 detail-value" id="detailStructure">-</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="row">
                        <div class="col-sm-4 detail-label">å»¶åºŠé¢ç©</div>
                        <div class="col-sm-8 detail-value" id="detailFloorArea">-</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="row">
                        <div class="col-sm-4 detail-label">å»ºç¯‰å¹´</div>
                        <div class="col-sm-8 detail-value" id="detailBuildYear">-</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="row">
                        <div class="col-sm-4 detail-label">ç¯‰å¹´æ•°</div>
                        <div class="col-sm-8 detail-value" id="detailAge">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button class="btn btn-lg btn-success" id="saveResultBtn">
                <i class="bi bi-save"></i> ã“ã®çµæœã‚’ä¿å­˜
            </button>
            <button class="btn btn-lg btn-outline-secondary" id="newCalculationBtn">
                <i class="bi bi-arrow-repeat"></i> æ–°ã—ã„è¨ˆç®—
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è¦ç´ ã®å–å¾—
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const manualForm = document.getElementById('manualForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultArea = document.getElementById('resultArea');
    const saveResultBtn = document.getElementById('saveResultBtn');
    const newCalculationBtn = document.getElementById('newCalculationBtn');

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.remove('dragover');
        });
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
    uploadArea.addEventListener('drop', function(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
        }
    });

    // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    uploadArea.addEventListener('click', function(e) {
        if (e.target.tagName !== 'LABEL' && e.target.tagName !== 'INPUT') {
            fileInput.click();
        }
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
        }
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / 1048576).toFixed(2) + ' MB';
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('input_method', 'file');

        await submitValuation(formData);
    });

    // æ‰‹å‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    manualForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
        const formData = {
            address: document.getElementById('address').value,
            land_area: parseFloat(document.getElementById('land_area').value),
            total_floor_area: parseFloat(document.getElementById('total_floor_area').value),
            building_structure: document.getElementById('building_structure').value,
            build_year: parseInt(document.getElementById('build_year').value)
        };

        await submitValuationJSON(formData);
    });

    // è©•ä¾¡é¡è¨ˆç®—ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
    async function submitValuation(formData) {
        try {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            resultArea.style.display = 'none';
            loadingSpinner.style.display = 'block';

            const response = await fetch('{{ url_for("valuation") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            loadingSpinner.style.display = 'none';

            if (data.success) {
                displayResult(data.result);
            } else {
                showError(data.error || 'è©•ä¾¡é¡ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        } catch (error) {
            loadingSpinner.style.display = 'none';
            showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            console.error('Error:', error);
        }
    }

    // è©•ä¾¡é¡è¨ˆç®—ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆæ‰‹å‹•å…¥åŠ›ç”¨ãƒ»JSON APIï¼‰
    async function submitValuationJSON(data) {
        try {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            resultArea.style.display = 'none';
            loadingSpinner.style.display = 'block';

            const response = await fetch('{{ url_for("api_valuate") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            loadingSpinner.style.display = 'none';

            if (result.success) {
                displayResult(result.result);
            } else {
                showError(result.error || 'è©•ä¾¡é¡ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        } catch (error) {
            loadingSpinner.style.display = 'none';
            showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            console.error('Error:', error);
        }
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger alert-dismissible fade show mt-3';
        errorAlert.setAttribute('role', 'alert');
        errorAlert.innerHTML = `
            <strong><i class="bi bi-exclamation-triangle"></i> ã‚¨ãƒ©ãƒ¼</strong>
            <p class="mb-0 mt-2">${message}</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
        const existingAlert = document.querySelector('.alert-danger');
        if (existingAlert) {
            existingAlert.remove();
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã®å¾Œã«æŒ¿å…¥
        loadingSpinner.parentElement.insertBefore(errorAlert, loadingSpinner.nextSibling);

        // 5ç§’å¾Œã«è‡ªå‹•çš„ã«éè¡¨ç¤º
        setTimeout(() => {
            errorAlert.classList.remove('show');
            setTimeout(() => errorAlert.remove(), 150);
        }, 5000);
    }

    // çµæœè¡¨ç¤º
    function displayResult(result) {
        // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
        const existingAlert = document.querySelector('.alert-danger');
        if (existingAlert) {
            existingAlert.remove();
        }

        // è©•ä¾¡é¡ã®è¡¨ç¤º
        document.getElementById('totalValuation').textContent =
            'Â¥' + result.total_valuation.toLocaleString();
        document.getElementById('landValuation').textContent =
            'Â¥' + result.land_valuation.toLocaleString();
        document.getElementById('buildingValuation').textContent =
            'Â¥' + result.building_valuation.toLocaleString();

        // è©³ç´°æƒ…å ±ã®è¡¨ç¤º
        document.getElementById('detailAddress').textContent = result.address;
        document.getElementById('detailLandArea').textContent = result.land_area + ' ã¡';
        document.getElementById('detailRoadPrice').textContent =
            'Â¥' + result.road_price.toLocaleString() + ' / ã¡';
        document.getElementById('detailStructure').textContent = result.building_structure;
        document.getElementById('detailFloorArea').textContent = result.total_floor_area + ' ã¡';
        document.getElementById('detailBuildYear').textContent = result.build_year + ' å¹´';

        const currentYear = new Date().getFullYear();
        const age = currentYear - result.build_year;
        document.getElementById('detailAge').textContent = age + ' å¹´';

        // çµæœã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        resultArea.style.display = 'block';
        resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // ä¿å­˜ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        saveResultBtn.dataset.result = JSON.stringify(result);
    }

    // çµæœä¿å­˜
    saveResultBtn.addEventListener('click', async function() {
        const result = JSON.parse(this.dataset.result);

        // ä¿å­˜ä¸­ã®è¡¨ç¤º
        const originalText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ä¿å­˜ä¸­...';

        try {
            const response = await fetch('{{ url_for("save_property") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(result)
            });

            const data = await response.json();

            if (data.success) {
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.setAttribute('role', 'alert');
                successAlert.innerHTML = `
                    <strong><i class="bi bi-check-circle"></i> ä¿å­˜å®Œäº†</strong>
                    <p class="mb-0 mt-2">è©•ä¾¡çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™...</p>
                `;
                resultArea.insertBefore(successAlert, resultArea.firstChild);

                // 1.5ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                setTimeout(() => {
                    window.location.href = '{{ url_for("dashboard") }}';
                }, 1500);
            } else {
                showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                this.disabled = false;
                this.innerHTML = originalText;
            }
        } catch (error) {
            showError('ä¿å­˜ä¸­ã«é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            this.disabled = false;
            this.innerHTML = originalText;
            console.error('Error:', error);
        }
    });

    // æ–°ã—ã„è¨ˆç®—
    newCalculationBtn.addEventListener('click', function() {
        resultArea.style.display = 'none';
        uploadForm.reset();
        manualForm.reset();
        fileInfo.style.display = 'none';
        uploadBtn.disabled = true;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});
</script>
{% endblock %}
